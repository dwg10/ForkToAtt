{% load otree static %}
{% block content %}

<style>
    @import url(https://fonts.googleapis.com/css?family=Work+Sans:300,600);

    body {
        font-family: 'Work Sans', sans-serif;
        color: #333;
        font-weight: 300;
        text-align: center;
        background-color: #f8f6f0;
    }

    h1 {
        font-size: 1.3em;
        text-align: left;
        padding: 4vh;
        background-color: rgba(59, 121, 139, 0.678);
        color: white;
    }

    .question {
        font-size: 1.4em;
        height: 10vh;
        margin-bottom: 4vh;
        padding: 3vh;
    }

    .answers {
        font-size: 1.2em;
        margin-top: 3vh;
        margin-bottom: 10vh;
        text-align: left;
        display: inline-block;
        height: 20vh;
    }

    .Demo-label {
        display: block;
        margin-bottom: 10px;
    }

    .QT-radio {
        display: block;
        margin: 0 auto;
    }

    .QT-label {
        font-size: 1em;
        display: inline-block;
        width: 10vw;
        text-align: center;
    }

    .button {
        font-family: 'Work Sans', sans-serif;
        font-size: 1.2em;
        font-style: bold;
        background-color: rgb(33, 202, 132);
        color: #fff;
        border: 0px;
        border-radius: 3px;
        padding: 4vh;
        cursor: pointer;
        margin-top: 15vh;
        text-decoration: none;
    }

    .button:hover {
        background-color: rgb(39, 221, 145);
        color: #fff;
    }

    .slide {
        position: absolute;
        left: 0px;
        top: 0px;
        width: 100%;
        z-index: 1;
        opacity: 0;
        transition: opacity 0.5s;
    }

    .active-slide {
        opacity: 1;
        z-index: 2;
    }

    .quiz-container {
        position: relative;
        height: 40vh;
        margin-top: 5vh;
    }

    .demo-textbox {
        font-size: 0.8em;
    }

    .progress-bar {
        display: inline-block;
        width: 20vw;
        opacity: 0.7;
        text-align: center;
        -webkit-appearance: none;
        appearance: none;
    }
</style>

<body>

    <h1>That was the end of the experiment. Next, we would like you to answer a few questions.</h1>

    <div class="quiz-container">
        <div id="quiz"></div>
    </div>
    <a id="previous" class="button" onclick=showPreviousSlide()>Previous</a>
    <a id="next" class="button" onclick=showNextSlide()> Next</a>
    <button id="submit" class="button" onclick=showResults()>Submit</button>

    <div id="otreeData"></div>


</body>
{% endblock %}

<!-- JAVASCRIPT -->

<script>
    //<script type="text/javascript" src="{% static 'questionnaire.json' %}">// 
    (function () {
        // Functions
        function buildQuiz() {
            // variable to store the HTML output
            const output = [];
            // variable to define the length of the progress bar
            const progressLimit = myQuestions.length;
            // for each question...
            myQuestions.forEach(
                (currentQuestion, questionNumber) => {

                    // variable to store the list of possible answers
                    const answers = [];

                    // and for each available answer...
                    if (currentQuestion.type === "radio") {

                        for (letter in currentQuestion.answers) {

                            // ...add an HTML radio button 
                            answers.push(
                                `<label class="Demo-label">
                      <input type="radio" name="question${questionNumber}" value="${letter}">             
                      ${currentQuestion.answers[letter]}
                    </label>`
                            );
                        }
                    } else if (currentQuestion.type === "radioHorizontal") {
                        answers.push(
                            `<div>
                      <label class="QT-label"><input type="radio" class="QT-radio" name="question${questionNumber}" value="1"/> Strongly disagree
                      </label><label class="QT-label">                  
                      <input type="radio" class="QT-radio" name="question${questionNumber}" value="2"/> Disagree
                      </label><label class="QT-label">
                      <input type="radio" class="QT-radio" name="question${questionNumber}" value="3"/> Neutral
                      </label><label class="QT-label">
                      <input type="radio" class="QT-radio" name="question${questionNumber}" value="4"/> Agree
                      </label><label class="QT-label">
                      <input type="radio" class="QT-radio" name="question${questionNumber}" value="5"/> Strongly agree            
                    </label></div>`
                        );
                    } else if (currentQuestion.type === "longOpen") {
                        answers.push(
                            `<label class="Demo-label">
                      <textarea class="demo-textbox" type="text" id = "question${questionNumber}" name="question${questionNumber}" rows="5" cols= "50"></textarea>
                    </label>`
                        );
                    } else {
                        answers.push(
                            `<label class="Demo-label">
                      <textarea class="demo-textbox" type="text" id = "question${questionNumber}" name="question${questionNumber}" rows="1" cols= "50"></textarea>
                    </label>`
                        );
                    }

                    // add this question and its answers to the output
                    output.push(
                        `<div class="slide">
                    <div class="question"> ${currentQuestion.question} </div>
                    <div class="answers"> ${answers.join("")} </div>
                    <br>
                    <label> 0% </label>
                        <progress class="progress-bar" min="1" max="${progressLimit}" value="${questionNumber + 1}"></progress>
                        <label> 100% </label>
                  </div>`
                    );
                }
            );

            // finally combine our output list into one string of HTML and put it on the page
            quizContainer.innerHTML = output.join('');
        }

        function showResults() {

            // gather answer containers from our quiz
            const answerContainers = quizContainer.querySelectorAll('.answers');

            // for each question...
            myQuestions.forEach((currentQuestion, questionNumber) => {

                // find selected answer
                const answerContainer = answerContainers[questionNumber];
                let selector = '';
                let userAnswer = '';
                if (currentQuestion.type === "radio" || currentQuestion.type === "radioHorizontal") {
                    selector = `input[name=question${questionNumber}]:checked`;
                    userAnswer = (answerContainer.querySelector(selector) || {}).value;
                } else {
                    selector = `textarea[name=question${questionNumber}]`;
                    userAnswer = (answerContainer.querySelector(selector)).value;
                }
                // save the user answers on oTree by creating hidden html with name that matches names in init
                let saveOtree = document.getElementById('otreeData');
                recordAnswer.push(
                    `<input type="hidden" name="${currentQuestion.name}" value="${userAnswer}">`
                );
                saveOtree.innerHTML = recordAnswer.join('');
            });
        }

        // Question slides: show one by one
        function showSlide(n) {
            slides[currentSlide].classList.remove('active-slide');
            slides[n].classList.add('active-slide');
            currentSlide = n;
            if (currentSlide === 0) {
                previousButton.style.display = 'none';
            }
            else {
                previousButton.style.display = 'inline-block';
            }
            if (currentSlide === slides.length - 1) {
                nextButton.style.display = 'none';
                submitButton.style.display = 'inline-block';
            }
            else {
                nextButton.style.display = 'inline-block';
                submitButton.style.display = 'none';
            }
        }

        function showPreviousSlide() {
            showSlide(currentSlide - 1);
        }

        // Variables
        const quizContainer = document.getElementById('quiz');
        const resultsContainer = document.getElementById('results');
        const submitButton = document.getElementById('submit');

        // array for saving the html with correct 
        let recordAnswer = []


        // object containing questions + names. Name needs to match the name given in init.py under class Questionnaire(Page) form_fields!
        const myQuestions = [
            {
                question: "What is your age?",
                name: "D1",
                type: "open",
            },
            {
                question: "Which gender do you identify the most with?",
                name: "D2",
                type: "radio",
                answers: {
                    1: "Female",
                    2: "Male",
                    3: "Other",
                    4: "Prefer not to say"
                },
            },
            {
                question: "What country do you live in?",
                name: "D3",
                type: "open",
            },
            {
                question: "What is your nationality?",
                name: "D4",
                type: "open",
            },
            {
                question: "Have you ever participated in an incentivized economic experiment (such as this one) before?",
                name: "D5",
                type: "radio",
                answers: {
                    1: "Yes",
                    2: "No",
                    3: "Not sure / don't remember"
                }
            },
            {
                question: "What do you think is the purpose of this study? Describe shortly in your own words.",
                name: "D6",
                type: "longOpen",
            },
            {
                question: "During the experiment, did you use any specific strategy or rule of thumb when deciding which of the two products to purchase? If so, describe it shortly.",
                name: "D7",
                type: "longOpen",
            },
            {
                question: "Reducing water consumption is necessary for sustainable development.",
                name: "QT1",
                type: "radioHorizontal",
            },
            {
                question: "Preserving the variety of living creatures is necessary for sustainable development (preserving biological diversity).",
                name: "QT2",
                type: "radioHorizontal",
            },
            {
                question: "For sustainable development, people need to be educated in how to protect themselves against natural disasters.",
                name: "QT3",
                type: "radioHorizontal",
            },
            {
                question: "A culture where conflicts are resolved peacefully through discussion is necessary for sustainable development.",
                name: "QT4",
                type: "radioHorizontal",
            },
            {
                question: "Respecting human rights is necessary for sustainable development.",
                name: "QT5",
                type: "radioHorizontal",
            },
            {
                question: "To achieve sustainable development, all the people in the world must have access to good education.",
                name: "QT6",
                type: "radioHorizontal",
            },
            {
                question: "Sustainable development requires that companies act responsibly towards their employees, customers and suppliers.",
                name: "QT7",
                type: "radioHorizontal",
            },
            {
                question: "Sustainable development requires a fair distribution of goods and services among people in the world.",
                name: "QT8",
                type: "radioHorizontal",
            },
            {
                question: "Wiping out poverty in the world is necessary for sustainable development.",
                name: "QT9",
                type: "radioHorizontal",
            },
            {
                question: "I think that using more natural resources than we need does not threaten the health and well‐being of people in the future.",
                name: "QT10",
                type: "radioHorizontal",
            },
            {
                question: "I think that we need stricter laws and regulations to protect the environment.",
                name: "QT11",
                type: "radioHorizontal",
            },
            {
                question: "I think that it is important to take measures against problems which have to do with climate change.",
                name: "QT12",
                type: "radioHorizontal",
            },
            {
                question: "I think that everyone ought to be given the opportunity to acquire the knowledge, values and skills that are necessary to live sustainably.",
                name: "QT13",
                type: "radioHorizontal",
            },
            {
                question: "I think that we who are living now should make sure that people in the future enjoy the same quality of life as we do today.",
                name: "QT14",
                type: "radioHorizontal",
            },
            {
                question: "I think that women and men throughout the world must be given the same opportunities for education and employment.",
                name: "QT15",
                type: "radioHorizontal",
            },
            {
                question: "I think that companies have a responsibility to reduce the use of packaging and disposable articles.",
                name: "QT16",
                type: "radioHorizontal",
            },
            {
                question: "I think it is important to reduce poverty.",
                name: "QT17",
                type: "radioHorizontal",
            },
            {
                question: "I think that companies in rich countries should give employees in poor nations the same conditions as in rich countries.",
                name: "QT18",
                type: "radioHorizontal",
            },
            {
                question: "I recycle as much as I can.",
                name: "QT19",
                type: "radioHorizontal",
            },
            {
                question: "I always separate food waste before putting out the rubbish when I have the chance.",
                name: "QT20",
                type: "radioHorizontal",
            },
            {
                question: "I have changed my personal lifestyle in order to reduce waste (e.g., throwing away less food or not wasting materials).",
                name: "QT21",
                type: "radioHorizontal",
            },
            {
                question: "When I use a computer or mobile to chat, to text, to play games and so on, I always treat others as respectfully as I would in real life.",
                name: "QT22",
                type: "radioHorizontal",
            },
            {
                question: "I support an aid organization or environmental group.",
                name: "QT23",
                type: "radioHorizontal",
            },
            {
                question: "I show the same respect to men and women, boys and girls.",
                name: "QT24",
                type: "radioHorizontal",
            },
            {
                question: "	I do things which help poor people.",
                name: "QT25",
                type: "radioHorizontal",
            },
            {
                question: "I often purchase second‐hand goods over the internet or in a shop",
                name: "QT26",
                type: "radioHorizontal",
            },
            {
                question: "I avoid buying goods from companies with a bad reputation for looking after their employees and the environment.",
                name: "QT27",
                type: "radioHorizontal",
            },
        ];

        // Kick things off
        buildQuiz();

        // Pagination
        const previousButton = document.getElementById("previous");
        const nextButton = document.getElementById("next");
        const slides = document.querySelectorAll(".slide");
        let currentSlide = 0;

        // Show the first slide
        showSlide(currentSlide);

        // Event listeners
        submitButton.addEventListener('click', showResults);
        previousButton.addEventListener("click", showPreviousSlide);
        nextButton.addEventListener("click", showNextSlide);

        // Keypress controls next/previous slide
        document.addEventListener('keydown', (event) => {
            let keypress = event.key;
            if (keypress === 'Enter') { // click 'Enter' = next slide
                showNextSlide();
            } else if (keypress === 'Backspace') { // click 'backspace' = previous slide
                showPreviousSlide();
            }
        });

        // prevent submitting the questionnaire if user click "Enter"
        $(document).ready(function () {
            $(window).keydown(function (event) {
                if (event.keyCode == 13) {
                    event.preventDefault();
                    return false;
                }
            });
        });

        //initialize slide count for showNextSlide()
        let slideCount = 0;

        // This function runs if user click "Next" (or "Enter"). It lets the user go to the next question (slide) only if answer was given to the current questions. The user cannot leave answer fields empty. 
        function showNextSlide() {
            slideCount = slideCount + 1; // increase slide count by one

            // create variable to store question type
            let questionTypes = []; 
            // for each question, get question type and store in variable
            myQuestions.forEach(Question => { 
                questionTypes.push(Question.type)
            });

            // run this code until all questions have been checked
            if (slideCount < myQuestions.length) {
                // initialize counter to index current question/answer from arrays
                let counter = slideCount - 1;
                // get all answers and save in container
                const answerSelector = quizContainer.querySelectorAll('.answers');
                // select current answer container
                let answerContainer2 = answerSelector[counter];
                // create variables to save current answer
                let selection = '';
                let checkAnswer = '';
                
                // based on question type (open, longOpen, radio, radioHorizontal), get current answer
                if (questionTypes[counter] === "open" || questionTypes[counter] === "longOpen") {
                    selection = `textarea[name=question${counter}]`;
                    checkAnswer = (answerContainer2.querySelector(selection)).value;
                } else {
                    checkAnswer = answerContainer2.querySelector(`input[name=question${counter}]:checked`);
                }

                // if answer container is empty, return slide count back to where it was. If answer container was not empty, move to next question.
                if (checkAnswer == null || checkAnswer == "") {
                    slideCount = slideCount - 1;
                } else {
                    showSlide(currentSlide + 1);
                }

            }
        };

    })();

</script>